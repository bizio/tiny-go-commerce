syntax = "proto3";

package order.v1;

option go_package = "github.com/optimatelabs/tiny-go-commerce/pkg/order/v1";

import "validate/validate.proto";

// Status of the order throughout its lifecycle.
enum OrderStatus {
  ORDER_STATUS_UNSPECIFIED = 0;
  ORDER_STATUS_PENDING = 1;
  ORDER_STATUS_PAID = 2;
  ORDER_STATUS_SHIPPED = 3;
  ORDER_STATUS_DELIVERED = 4;
  ORDER_STATUS_CANCELLED = 5;
}

// The Order message represents a completed checkout.
message Order {
  int64 id = 1 [(validate.rules).int64.gt = 0];
  int64 user_id = 2 [(validate.rules).int64.gt = 0];
  repeated OrderItem items = 3;
  double total_amount = 4 [(validate.rules).double.gte = 0];
  OrderStatus status = 5 [(validate.rules).enum.defined_only = true];
  ShippingAddress shipping_address = 6 [(validate.rules).message.required = true];
  string created_at = 7;
  string updated_at = 8;
}

// OrderItem represents a finalized line-item from a product purchase.
message OrderItem {
  int64 product_id = 1 [(validate.rules).int64.gt = 0];
  int32 quantity = 2 [(validate.rules).int32.gt = 0];
  double unit_price = 3 [(validate.rules).double.gte = 0]; 
}

// ShippingAddress is a denormalized snapshot of where the order is going.
message ShippingAddress {
  string street = 1 [(validate.rules).string.min_len = 1];
  string city = 2 [(validate.rules).string.min_len = 1];
  string state = 3 [(validate.rules).string.min_len = 1];
  string zip = 4 [(validate.rules).string.min_len = 1];
  string country = 5 [(validate.rules).string.len = 2];
}

// Request to create an order (Checkout).
message CreateOrderRequest {
  int64 user_id = 1 [(validate.rules).int64.gt = 0];
  int64 cart_id = 2; // Optional, so no strict validation here initially besides format if provided
  ShippingAddress shipping_address = 3 [(validate.rules).message.required = true];
}

// Response for creating an order.
message CreateOrderResponse {
  Order order = 1;
}

// Request to get a specific order.
message GetOrderRequest {
  int64 id = 1 [(validate.rules).int64.gt = 0];
}

// Response for getting a specific order.
message GetOrderResponse {
  Order order = 1;
}

// Request to list a user's orders.
message ListOrdersRequest {
  int64 user_id = 1 [(validate.rules).int64.gt = 0];
  int32 page_size = 2 [(validate.rules).int32 = {gte: 0, lte: 100}];
  string page_token = 3;
}

// Response for listing orders.
message ListOrdersResponse {
  repeated Order orders = 1;
  string next_page_token = 2;
}

// Request to update the status of an order.
message UpdateOrderStatusRequest {
  int64 id = 1 [(validate.rules).int64.gt = 0];
  OrderStatus status = 2 [(validate.rules).enum = {defined_only: true, not_in: [0]}];
}

// Response for updating the status of an order.
message UpdateOrderStatusResponse {
  Order order = 1;
}

// OrderService provides checkout and order management operations.
service OrderService {
  rpc CreateOrder(CreateOrderRequest) returns (CreateOrderResponse);
  rpc GetOrder(GetOrderRequest) returns (GetOrderResponse);
  rpc ListOrders(ListOrdersRequest) returns (ListOrdersResponse);
  rpc UpdateOrderStatus(UpdateOrderStatusRequest) returns (UpdateOrderStatusResponse);
}
